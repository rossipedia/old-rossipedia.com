<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Decoupling metadata from your models - Rossipedia</title>
    <link rel="shortcut icon" href="http://www.gravatar.com/avatar/74c4a12ee78a7e49b8333a6c78aae47c.png">
    <link rel="stylesheet" type="text/css" href="/styles/main.css">
    <link rel="stylesheet" href="/styles/hl/github.css">
    <script type="text/javascript" src="/scripts/ender.js"></script>
    <link rel="canonical" href="http://rossipedia.com/blog/2012/05/decoupling-metadata-from-your-models">
  </head>
  <body>
    <input type="checkbox" id="sidebar-checkbox" class="sidebar-checkbox">
    <section class="wrap">
      <section class="masthead">
        <header role="banner" class="container">
          <h1><a href="/">Rossipedia</a></h1>
          <h2>Code, music, and other junk</h2>
        </header>
      </section>
      <section class="main container">
        <article>
          <header>
            <h1><a href="/blog/2012/05/decoupling-metadata-from-your-models">Decoupling metadata from your models</a></h1>
            <time datetime="2012-05-28T06:00:00.000Z">May 28 2012</time><a rel="author">Bryan J. Ross</a>
          </header>
          <section class="content"><p>Most of the time, decorating your models with validation attributes
works just fine. But sometimes you need to separate your validation
logic from your models. For example, re-using your models across
multiple projects, but each project has it’s own validation rules.</p>
<!-- more -->

<h2 id="the-standard-approach">The standard approach</h2>
<p>However, there’s a wealth of functionality that is supplied with the
DataAnnotations attributes. The standard way of decoupling your
DataAnnotations and models is the MetadataTypeAttribute. You use it
like so:</p>
<pre><code class="lang-csharp">using System;
using System.ComponentModel.DataAnnotations;
[MetadataType(typeof(AddressMeta))]
public class Address
{
  public int Id { get; set; }
  public string Address1 { get; set; }
  public string Address2 { get; set; }
  public string City { get; set; }
  public string State { get; set; }
  public string Zip { get; set; }
  public class AddressMeta
  {
    [Required]
    public int Id;
    [Required]
    public string Address1;
    /* etc. etc. */
  }
}
</code></pre>
<p>This approach works fine for most cases. However, in some cases, you
need to specify validation rules separately from your models. Some may
argue that that’s bad design, but arguing design isn’t the point of
this post.</p>
<p>Now, there’s plenty of validation libraries out there for MVC out
there, but what if you want to use the existing DataAnnotations
attributes, and just specify them somewhere else? Turns out, that’s
pretty easy.</p>
<h2 id="throwing-it-in-reverse">Throwing it in reverse</h2>
<p>What I want to do is something like this:</p>
<pre><code class="lang-csharp">using System;
using System.ComponentModel.DataAnnotations;
public class Address
{
  public int Id { get; set; }
  public string Address1 { get; set; }
  public string Address2 { get; set; }
  public string City { get; set; }
  public string State { get; set; }
  public string Zip { get; set; }
}

[MetadataFor(typeof(Address))]
public class AddressMeta
{
  [Required]
  public int Id;
  [Required]
  public string Address1;
  /* etc. etc. */
}
</code></pre>
<p>MVC allows for an amazing amount of customization. It uses a Provider
architecture to get what it needs for various operations and
functionality, so customizing the Metadata and Validator lookups just
require adding a specialized provider.</p>
<p>First, we’re going to need a custom attribute for marking the Metadata
classes, and then we’ll need a provider for both Metadata, and for
Validators. The code is as follows:</p>
<pre><code class="lang-csharp">[AttributeUsage(AttributeTargets.Class)]
public class MetadataForAttribute : Attribute
{
  public MetadataForAttribute() {}
  public MetadataForAttribute(Type forType) { ForType = forType;
  }
  public Type ForType { get; set; }
  public static Type GetTargetType(Type fromType)
  {
    var attr =
      (MetadatForAttribute)Attribute.GetCustomAttribute(fromType,
          typeof(MetadataForAttribute));
    return attr.ForType;
  }
}

public class MetadataForMetadataProvider :
  DataAnnotationsModelMetadataProvider
{
  public Dictionary MetadataTypeMap { get; private set; }

  public MetadataForMetadataProvider()
  {
    var assemblies = AppDomain.CurrentDomain.GetAssemblies();
    var allTypes = assemblies.SelectMany(a =&gt; a.GetTypes());
    var metadataTypes = allTypes.Where(
        t =&gt; Attribute.IsDefined(t, typeof(MetadataForAttribute))).ToList();
    MetadataTypeMap = metadataTypes.ToDictionary(
        MetadataForAttribute.GetTargetType,
        t =&gt; t);
  }

  public MetadataForMetadataProvider(Dictionary typeMap)
  {
    MetadataTypeMap = typeMap;
  }

  protected override ICustomTypeDescriptor
    GetTypeDescriptor(Type type)
    {
      if (MetadataTypeMap.ContainsKey(type))
      {
        var provider = new AssociatedMetadataTypeTypeDescriptionProvider(type, MetadataTypeMap[type]);
        return provider.GetTypeDescriptor(type);
      }
      else
        return base.GetTypeDescriptor(type);
    }
}

public class MetadataForValidatorProvider :
  DataAnnotationsModelValidatorProvider
{
  public Dictionary MetadataTypeMap { get; private set; }

  public MetadataForValidatorProvider()
  {
    var assemblies = AppDomain.CurrentDomain.GetAssemblies();
    var allTypes = assemblies.SelectMany(a =&gt; a.GetTypes());

    var metadataTypes = allTypes.Where(
        t =&gt; Attribute.IsDefined(t, typeof(MetadataForAttribute))).ToList();

    MetadataTypeMap = metadataTypes.ToDictionary(
        MetadataForAttribute.GetTargetType,
        t =&gt; t);
  }

  public MetadataForValidatorProvider(Dictionary typeMap)
  {
    MetadataTypeMap = typeMap;
  }

  protected override ICustomTypeDescriptor
    GetTypeDescriptor(Type type)
    {
      if (MetadataTypeMap.ContainsKey(type))
      {
        var provider = new AssociatedMetadataTypeTypeDescriptionProvider(type, MetadataTypeMap[type]);
        return provider.GetTypeDescriptor(type);
      }
      else
        return base.GetTypeDescriptor(type);
    }
}
</code></pre>
<p>There might be a better way of doing this, but this way is
straightforward, easy to debug, and only incurs a one time cost at
application startup. Registering these providers is relatively simple.
Just add the following to your Global.asax.cs (or, god forbid
Global.asax.vb *YUCK*), in the Application_Starup method:</p>
<pre><code class="lang-csharp">var metadataForProvider = new MetadataForMetadataProvider();
ModelMetadataProviders.Current = metadataForProvider;
providers.Clear();
providers.Add(new MetadataForValidatorProvider(metadataForProvider.MetadataTypeMap));
</code></pre>
<p>And voila. Note, that this will also work with model hierarchies. Say
you want to extend a model into something like an AddressViewModel
with additional properties, perhaps for custom formatting, etc.. The
following will do the trick just nicely:</p>
<pre><code class="lang-csharp">public class Contact
{
  public int Id { get; set; }
  public string FirstName { get; set; }
  public string LastName { get; set; }
}

public class ContactViewModel : Contact
{
  public string FullName
  {
    get { return FirstName + &quot; &quot; + LastName; }
    set
    {
      var parts = value.Split(new [] { &#39; &#39; }, 2);
      FirstName = parts;
      LastName = parts;
    }
  }
}

[MetadataFor(typeof(Contact))]
public class ContactMeta
{
  [Required]
    public int Id;
  [Required]
    public string FirstName;
  [Required]
    public string LastName;
}

[MetadataFor(typeof(ContactViewModel))]
public class ContactViewModelMeta : ContactMeta
{
  [Description(&quot;Full Name&quot;)]
    public string FullName;
}
</code></pre>

          </section>
          <section class="comments">
            <div id="disqus_thread"></div>
          </section>
        </article>
      </section>
      <footer class="container">
        <ul class="nav">
          <li><a href="/blog/2012/03/hello-there">&lt;</a></li>
          <li><a href="/blog/">Archives</a></li>
          <li><a href="/blog/2012/05/thoughts-on-windows-8">&gt;</a></li>
        </ul><p>&copy; 2014 content and design by
<a href="href=&quot;http://rossipedia.com&quot;">Bryan J. Ross</a></p>

      </footer>
      <section class="sidebar-wrap">
        <label for="sidebar-checkbox" class="sidebar-toggle"></label>
        <section class="sidebar">
          <aside>
            <p>Code MacGuyver @ <a href="http://stackexchange.com" target="_blank">StackExchange</a></p>
            <p>I've been known to play and record music.</p>
          </aside>
          <section class="search">
            <form action="http://google.com/search" method="get" class="search">
              <input type="hidden" name="q" value="site:rossipedia.com">
              <input type="text" name="q" placeholder="Search..." class="search"><span class="rss"><a href="atom.xml" title="Subscribe to the RSS feed">RSS</a></span>
            </form>
          </section>
          <section>
            <h2>Recent Posts<a href="/blog/">&nbsp;- more</a></h2>
            <nav class="recent">
              <ul>
                <li><a href="/blog/2013/08/dependency-injection-considered-harmful-not-so-fast-">Dependency Injection considered harmful? Not so fast.</a></li>
                <li><a href="/blog/2013/06/ergodox-mechanical-keyboard-review">ErgoDox Mechanical Keyboard Review</a></li>
                <li><a href="/blog/2013/03/elmah-emails-and-servicestack">Elmah, Emails, and ServiceStack</a></li>
                <li><a href="/blog/2013/03/simple-api-key-authentication-with-servicestack">Simple API Key Authentication with ServiceStack</a></li>
                <li><a href="/blog/2013/02/integration-testing-with-servicestack">Integration Testing with ServiceStack</a></li>
                <li><a href="/blog/">More...</a></li>
              </ul>
            </nav>
          </section>
          <section class="stackoverflow"><a href="http://stackoverflow.com/users/115049/rossipedia"><img src="http://stackoverflow.com/users/flair/115049.png?theme=dark" width="208" height="58" alt="profile for rossipedia at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for rossipedia at Stack Overflow, Q&amp;A for professional and enthusiast programmers"></a></section>
          <section>
            <h2><a href="http://github.com/rossipedia">@rossipedia on GitHub</a></h2>
            <nav class="repos">
              <ul id="gh_repos">
                <li class="loading"><a>Status updating...</a></li>
              </ul>
            </nav>
            <script type="text/javascript" src="/scripts/github.js"></script>
          </section><a href="https://twitter.com/rossipedia" data-widget-id="381923369030934528" class="twitter-timeline">Tweets by @rossipedia</a>
          <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
        </section>
      </section>
    </section>
    <script src="/scripts/hl/highlight.pack.js"></script>
    <script type="text/javascript" src="/scripts/rossipedia.js"></script>
  </body>
</html>